åšå®¢åœ°å€ï¼š[README](https://qybit.gitee.io/2021/04/07/doubantop250/)

## å‰è¨€

é›†ä¸­ å­¦ä¹ +å¤ä¹  Go è¯­è¨€æœ‰ä¸€ä¸ªå¤šæ˜ŸæœŸäº†ï¼Œä¹Ÿè¯¥å†™ç‚¹ä¸œè¥¿äº†ã€‚

è¯´ä¸‹ä½¿ç”¨çš„ Go è¯­è¨€çš„æ„Ÿå—å§ï¼Œç›´è§‚ä¸Šæ¥è¯´ã€‚Go åˆšä¸Šæ‰‹æ˜¯æ¯”è¾ƒåäººç±»çš„ï¼Œæ¯”å¦‚å˜é‡åå’Œå˜é‡ç±»å‹çš„ä½ç½®æ˜¯åç€çš„ï¼Œå·²ç»å‡½æ•°å’Œæ–¹æ³•çš„è¿”å›å€¼çš„ä½ç½®å°±æ›´åŠ çš„å¥‡æ€ªäº†ã€‚ä½†æ˜¯ï¼Œæ€»ä½“çš„ä¸Šæ‰‹éš¾åº¦ä¸æ˜¯å¾ˆå¤§ã€‚ç›¸åï¼Œæˆ‘è®¤ä¸ºè¿™äº›ä¹Ÿæ˜¯ Go çš„ä¸€å¤§ç‰¹è‰²å§ã€‚æ€»ä½“çš„å­¦ä¹ é—¨æ§›æ˜¯æ¯”è¾ƒä½çš„ï¼Œè€Œä¸” Go èº«ä¸Šä¹Ÿæœ‰å¾ˆå¤š C/C++ çš„å½±å­ (æ¯”å¦‚æŒ‡é’ˆç±»å‹ï¼Œè¿˜æœ‰ç»“æ„ä½“)ã€‚æœ€è®©æˆ‘æ„Ÿåˆ°æ„å¤–çš„å°±æ˜¯ï¼ŒGo è¯­è¨€ä¸­çš„æ¥å£çš„è®¾è®¡ï¼ŒçœŸæ­£çš„åšåˆ°äº†ä½è€¦åˆã€‚å› ä¸ºåªè¦ä»»æ„ä¸€ä¸ªç»“æ„ä½“æˆ–è€…ç±»å‹å®ç°äº†æ¥å£ä¸­çš„æ–¹æ³•åï¼Œå°±ç®—æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„å®ç°äº†ä¸€ä¸ªæ¥å£ã€‚è€Œå½“æˆ‘ä»¬ä»ä»£ç é‡Œ "æ‹¿èµ°" è¿™ä¸ªæ¥å£æ—¶ï¼Œæ˜¯ä¸ä¼šå½±å“åˆ°å®ç°äº†è¯¥æ¥å£çš„ç»“æ„ä½“æˆ–è€…ç±»å‹ï¼Œå› ä¸ºé‚£åªæ˜¯å®ƒä»¬çš„æ–¹æ³•è€Œå·²ã€‚

ä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆè¦ä»çˆ¬è™«å¼€å§‹å®è·µï¼Ÿ

æˆ‘è®¤ä¸ºå…´è¶£æ˜¯æœ€å¥½çš„è€å¸ˆï¼Œæˆ‘ä¸å–œæ¬¢æ­»æ¿çš„å»å†™ â€xxxé€šè®¯å½•ç®¡ç†ç³»ç»Ÿâ€œ æˆ–è€… â€xxxç®¡ç†ç³»ç»Ÿâ€œ ä¹‹ç±»çš„æ— èŠ demoã€‚æˆ‘æ˜¯å…´è¶£é©±åŠ¨ï¼Œæˆ‘æ›´æ„¿æ„ä»çˆ¬è™«å…¥æ‰‹å»å­¦ä¹ ã€‚

æœ¬æ¥æ‰“ç®—æ‹¿æˆ‘çš„çœ‹å®¶æœ¬é¢† Senlium å‘¢ï¼Œç»“æœåˆ°å®˜ç½‘ä¸€æŸ¥è¿˜ä¸æ”¯æŒ Goã€‚

å¥½çš„ï¼Œè¯´çš„æœ‰ç‚¹å¤šäº†ï¼Œä¸‹é¢å¼€å§‹æˆ‘ä»¬çš„ Go è¯­è¨€çˆ¬è™«å®è·µå§ã€‚

é¡¹ç›®åœ°å€ï¼š[é¡¹ç›®åœ°å€](https://github.com/qybit/doubantop250)

## å‡†å¤‡å·¥ä½œ

å¼€å‘ç¯å¢ƒ

- go version go1.16.2 windows/amd64
- goland
- ç¬¬ä¸‰æ–¹åº“ goqueryï¼ˆä¸€ä¸ªç±»ä¼¼jQueryå¯ä»¥æ“ä½œDOMçš„åº“ï¼‰

## çŸ¥è¯†ç‚¹

- ç»“æ„ä½“
- å‡½æ•° / æ–¹æ³•
- http
- æ‡‚å¾— DOM ç¼–ç¨‹ï¼Œè‡³å°‘ä¼š JavaScript ä¸­çš„ DOM éƒ¨åˆ†
- æ­£åˆ™è¡¨è¾¾å¼
- å¼‚å¸¸å¤„ç†
- json
- io å¤„ç†

## å·¥ä½œç›®å½•

æˆ‘ä»¬çš„å·¥ä½œç›®å½•é•¿è¿™æ ·ğŸ‘‡ã€‚

![](https://cdn.jsdelivr.net/gh/qybit/CDN@master/Photo/my/doubantop250_0.png)

## å‘èµ·httpè¯·æ±‚

ä½œä¸ºä¸€åªåˆæ ¼çš„ç½‘ç»œçˆ¬è™«ï¼Œæˆ‘ä»¬å¿…é¡»è¦å¯ä»¥å‘èµ·åŸºæœ¬çš„ http è¯·æ±‚è·å¾—ç½‘é¡µæ•°æ®ã€‚

æ­£è§„çš„ç½‘ç«™ï¼Œä¸€èˆ¬æœ€åŸºç¡€çš„é˜²å¾¡å°±æ˜¯é€šè¿‡ User-Agent / Agent å­—æ®µçš„æ ¡éªŒï¼Œæ¥æ£€æµ‹æ˜¯ä¸æ˜¯çœŸäººç”¨æˆ·æ“ä½œã€‚æˆ‘ä»¬åªéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­åŠ å…¥è¿™ä¸€å­—æ®µï¼ŒæŠŠè‡ªå·± "ä¼ªè£…" æˆçœŸäººç”¨æˆ·ï¼Œå…·ä½“å†…å®¹å¯ä»¥åœ¨æµè§ˆå™¨æŸ¥çœ‹ã€‚è¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚

```go
// è·å–å†…å®¹
func fetchSinglePageContent(url string, start string) (io.Reader, error) {
	client := &http.Client{}
	request, err := http.NewRequest("GET", url+start, nil)
	if err != nil {
		return nil, err
	}
	request.Header.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36")
	request.Header.Add("Referer", "https://movie.douban.com/top250")
	resp, err := client.Do(request)
	if err != nil {
		return nil, err
	}
	return resp.Body, nil
}
```

## ä½¿ç”¨è·å–çš„å“åº”å†…å®¹ï¼Œæ„å»º DOM æ ‘

è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬å°†ä¼šä½¿ç”¨ goquery åº“ï¼Œå®ƒä¼šå¸®åŠ©æˆ‘ä»¬æŠŠç½‘ç»œè¯·æ±‚çš„å“åº”å†…å®¹è§£ææˆä¸€é¢— DOM æ ‘ã€‚å¹¶æä¾›å’Œ JavaScript å’Œ jQuery ç±»ä¼¼çš„ API ä¾›æˆ‘ä»¬è®¿é—®æŸä¸ªèŠ‚ç‚¹ã€‚

è¿™é‡Œçš„ content å®é™…ä¸Šå°±æ˜¯ å“åº”çš„Body éƒ¨åˆ†ã€‚

```go
// è§£æè·å–çš„å†…å®¹ä¸º DOM æ ‘
func generatorDomTree(content io.Reader) (*goquery.Document, error) {
	reader, err := goquery.NewDocumentFromReader(content)
	if err != nil {
		return nil, err
	}
	return reader, nil
}
```

## è§£æå•ä¸ªé¡µé¢çš„æ‰€æœ‰ç”µå½±å†…å®¹

æˆ‘ä»¬æ‹¿åˆ°ä¸Šé¢ç”Ÿæˆçš„ goquery.Document å¯¹è±¡ï¼Œ goquery æä¾›çš„é€‰æ‹©å™¨çš„åŠŸèƒ½å’Œ jQuery å‡ ä¹ä¸€æ¨¡ä¸€æ ·ã€‚æ‰€ä»¥æœ‰è¿‡ jQuery ä½¿ç”¨ç»éªŒçš„è¯ï¼Œä¸Šæ‰‹ goquery æ˜¯éå¸¸å®¹æ˜“çš„ã€‚è¿™é‡Œçš„ç¨å¾®éº»çƒ¦ç‚¹çš„å°±æ˜¯æˆ‘ä»¬å¤„ç†å­—ç¬¦ä¸²çš„æ—¶å€™ã€‚

```go
// è·å–æ‰€æœ‰çš„ç”µå½±å¯¹åº”çš„ li æ ‡ç­¾
func parseSinglePage(doc *goquery.Document) ([]*entity.Movie, error) {
	var ret []*entity.Movie
	doc.Find("#content > div > div.article > ol > li").Each(func(i int, s *goquery.Selection) {
		cover, _ := s.Find(".pic a img").Eq(0).Attr("src")

		title := s.Find(".hd a span").Eq(0).Text()
		subtitle := s.Find(".hd a span").Eq(1).Text()
		subtitle = strings.TrimLeft(subtitle, "  /  ")

		other := s.Find(".hd a span").Eq(2).Text()
		other = strings.TrimLeft(other, "  /  ")

		desc := strings.TrimSpace(s.Find(".bd p").Eq(0).Text())
		DescInfo := strings.Split(desc, "\n")

		desc = DescInfo[0]

		movieDesc := strings.Split(DescInfo[1], "/")
		year := strings.TrimSpace(movieDesc[0])
		area := strings.TrimSpace(movieDesc[1])
		tag := strings.TrimSpace(movieDesc[2])

		star := s.Find(".bd star .rating_num").Text()

		comment := strings.TrimSpace(s.Find(".bd star span").Eq(3).Text())
		compile := regexp.MustCompile("[0-9]")
		comment = strings.Join(compile.FindAllString(comment, -1), "")

		quote := s.Find(".quote .inq").Text()

		movie := &entity.Movie{
			Title:    title,
			Subtitle: subtitle,
			Other:    other,
			Cover:    cover,
			Desc:     desc,
			Year:     year,
			Area:     area,
			Tag:      tag,
			Star:     star,
			Comment:  comment,
			Quote:    quote,
		}
		ret = append(ret, movie)
	})
	return ret, nil
}
```

## æ±‡æ€»

è¿™é‡Œå°†ä¼šè°ƒç”¨ä¸Šé¢çš„æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åæ ¹æ®ç”¨æˆ·è¾“å…¥çš„ä¿¡æ¯ï¼Œè¿›è¡Œå†³ç­–ã€‚

æ¯”å¦‚ä»å“ªä¸€é¡µå¼€å§‹è·å–ï¼Œä»¥åŠæ˜¯å¦éœ€è¦æŒä¹…åŒ–ç­‰

```go
// è§£æå•ä¸€é¡µé¢
func parseOnePage(start string, page int, ok bool) {
   content, err := fetchSinglePageContent(URL, start)
   if err != nil {
      fmt.Println("è·å–å†…å®¹æ—¶å‡ºé”™ï¼")
      return
   }
   dom, err := generatorDomTree(content)
   if err != nil {
      fmt.Println("è§£ææˆ DOM æ ‘çš„è¿‡ç¨‹ä¸­å‡ºé”™ï¼")
      return
   }
   books, err := parseSinglePage(dom)
   for _, book := range books {
      fmt.Println(book)
   }
   if ok {
      data, _ := json.Marshal(books)
      err := ioutil.WriteFile("page"+strconv.Itoa(page)+".txt", data, 0644)
      if err != nil {
         panic(err)
      }
   }
}
```

## æœ€ç»ˆæ•ˆæœ

![](https://cdn.jsdelivr.net/gh/qybit/CDN@master/Photo/my/toubantop250.png)

## ä»£ç 

### ä¾èµ–

```go
module qybit.com/doubantop250

go 1.16

require github.com/PuerkitoBio/goquery v1.6.1

```

### entiy åŒ…

```go
package entity

type Movie struct {
	Title    string `json:"title"`// ä¸­æ–‡å
	Subtitle string `json:"subtitle"`// è‹±æ–‡å
	Other    string `json:"other"`// æ¸¯æ¾³å°ç¿»è¯‘å
	Cover    string `json:"cover"`// ç”µå½±å°é¢
	Desc     string `json:"desc"`// æè¿°
	Year     string `json:"year"`// ä¸Šæ˜ å¹´ä»½
	Area     string `json:"area"`// å±äºå“ªä¸ªå›½å®¶
	Tag      string `json:"tag"`// å±äºå“ªä¸€ç±»å‹çš„ç”µå½±
	Star     string `json:"star"`// è¯„åˆ†
	Comment  string `json:"comment"`// å‚ä¸è¯„åˆ†çš„äººæ•°
	Quote    string `json:"quote"`// å®£ä¼ æ ‡è¯­
}
```

### spider åŒ…

```go
package spider

import (
	"encoding/json"
	"fmt"
	"github.com/PuerkitoBio/goquery"
	"io"
	"io/ioutil"
	"net/http"
	"qybit.com/doubantop250/entity"
	"regexp"
	"strconv"
	"strings"
)

const (
	URL          string = "https://movie.douban.com/top250?start="
	DefaultCover string = "https://img.imgdb.cn/item/601fdca33ffa7d37b326de61.jpg"
)


// è·å–å†…å®¹
func fetchSinglePageContent(url string, start string) (io.Reader, error) {
	client := &http.Client{}
	request, err := http.NewRequest("GET", url+start, nil)
	if err != nil {
		return nil, err
	}
	request.Header.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36")
	request.Header.Add("Referer", "https://movie.douban.com/top250")
	resp, err := client.Do(request)
	if err != nil {
		return nil, err
	}
	return resp.Body, nil
}

// è·å–æ‰€æœ‰çš„ç”µå½±å¯¹åº”çš„ li æ ‡ç­¾
func parseSinglePage(doc *goquery.Document) ([]*entity.Movie, error) {
	var ret []*entity.Movie
	doc.Find("#content > div > div.article > ol > li").Each(func(i int, s *goquery.Selection) {
		cover, _ := s.Find(".pic a img").Eq(0).Attr("src")

		title := s.Find(".hd a span").Eq(0).Text()
		subtitle := s.Find(".hd a span").Eq(1).Text()
		subtitle = strings.TrimLeft(subtitle, "  /  ")

		other := s.Find(".hd a span").Eq(2).Text()
		other = strings.TrimLeft(other, "  /  ")

		desc := strings.TrimSpace(s.Find(".bd p").Eq(0).Text())
		DescInfo := strings.Split(desc, "\n")

		desc = DescInfo[0]

		movieDesc := strings.Split(DescInfo[1], "/")
		year := strings.TrimSpace(movieDesc[0])
		area := strings.TrimSpace(movieDesc[1])
		tag := strings.TrimSpace(movieDesc[2])

		star := s.Find(".bd star .rating_num").Text()

		comment := strings.TrimSpace(s.Find(".bd star span").Eq(3).Text())
		compile := regexp.MustCompile("[0-9]")
		comment = strings.Join(compile.FindAllString(comment, -1), "")

		quote := s.Find(".quote .inq").Text()

		movie := &entity.Movie{
			Title:    title,
			Subtitle: subtitle,
			Other:    other,
			Cover:    cover,
			Desc:     desc,
			Year:     year,
			Area:     area,
			Tag:      tag,
			Star:     star,
			Comment:  comment,
			Quote:    quote,
		}
		ret = append(ret, movie)
	})
	return ret, nil
}

// è§£æè·å–çš„å†…å®¹ä¸º DOM æ ‘
func generatorDomTree(content io.Reader) (*goquery.Document, error) {
	reader, err := goquery.NewDocumentFromReader(content)
	if err != nil {
		return nil, err
	}
	return reader, nil
}

// è§£æå•ä¸€é¡µé¢
func parseOnePage(start string, page int, ok bool) {
	content, err := fetchSinglePageContent(URL, start)
	if err != nil {
		fmt.Println("è·å–å†…å®¹æ—¶å‡ºé”™ï¼")
		return
	}
	dom, err := generatorDomTree(content)
	if err != nil {
		fmt.Println("è§£ææˆ DOM æ ‘çš„è¿‡ç¨‹ä¸­å‡ºé”™ï¼")
		return
	}
	books, err := parseSinglePage(dom)
	for _, book := range books {
		fmt.Println(book)
	}
	if ok {
		data, _ := json.Marshal(books)
		err := ioutil.WriteFile("page"+strconv.Itoa(page)+".txt", data, 0644)
		if err != nil {
			panic(err)
		}
	}
}

func Run(page int, ok bool) {
	var k int = 0
	for i := 1; i <= page; i++ {
		parseOnePage(strconv.Itoa(k), i, ok)
		k += 25
	}
}

```

### app

```go
package main

import (
	"bufio"
	"fmt"
	"os"
	"qybit.com/doubantop250/spider"
	"strconv"
)

func main() {
	fmt.Print("è¯·è¾“å…¥è¦çˆ¬å–çš„é¡µæ•°ï¼Œæœ€å¤§10é¡µï¼š")
	cin := bufio.NewScanner(os.Stdin)
	cin.Scan()
	page, err := strconv.Atoi(cin.Text())
	if err != nil {
		fmt.Println("è¾“å…¥æ•°æ®ä¸åˆæ³•ï¼Œè¯·æŒ‰ç…§è¦æ±‚è¾“å…¥ï¼")
		os.Exit(1)
	}
	fmt.Print("æ˜¯å¦éœ€è¦æŒä¹…åŒ–ï¼Ÿï¼ˆè¯·è¾“å…¥ yes/y æˆ–è€… no/nï¼‰")
	cin.Scan()
	ok := cin.Text()
	isOk := false
	if ok == "yes" || ok == "y" {
		isOk = true
	}
	spider.Run(page, isOk)
}

```

